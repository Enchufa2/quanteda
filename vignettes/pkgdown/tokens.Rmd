---
title: "The external pointer-based tokens object"
author: Kohei Watanabe and Stefan MÃ¼ller
output:  
  html_document:
    toc: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    message = FALSE,
    comment = "##",
    fig.width = 8, 
    fig.height = 2, 
    dpi = 150
)
```

In **quanteda** version 4.0, we introduced a new class of tokens object, `tokens_xptr`. This object enhances the efficiency of adjusting tokens objects based on large text corpora. The package's `tokens` object has been a list of vectors that record integer IDs of tokens. Therefore, a `tokens` object is converted to a C++ object, modified and converted back to R every time `tokens_*` functions are applied. As the size of the object increases, the conversion between R and C++ takes much of the execution time. However, the `tokens_xptr` object is based on an external-pointer object that keeps the data as the C++ object, eliminating the cost of such conversions. Using the new `tokens_xptr`object can speed up the execution time substantively when working with large tokens objects (more than one million tokens) processed through a long pipeline. A detailed comparison of performance gains and execution times for `tokens` and `tokens_xptr` objects is available in a [separate vignette](./articles/tokens.html). 

## Creating tokens_xptr objects

You can create a `tokens_xptr` from `tokens` using the `as.tokens_xptr()` method. If `xtoks` is printed, the address of its underlying data is shown in the first line `(pointer to xxxx)`. As an external pointer object, the underlying data of the copy of the object `xtoks_copy` is the same. This means that operations on `xtoks` using `tokens_*` functions also affect `xtoks_copy` even after the copying (shallow copy). If you want to copy the underlying data of `xtoks_copy` objects (deep copy), `as.tokens_xptr()` should be applied to `xtoks`.

```{r, echo=FALSE, include=FALSE}
#data_corpus_guardian <- readRDS('/home/kohei/Dropbox/Public/data_corpus_guardian2016.rds') 
data_corpus_guardian <- readRDS('C:/Users/watan/Dropbox/Public/data_corpus_guardian2016.rds')
```

```{r}
require(quanteda)
require(ggplot2)

# reshape corpus to sentence-level
corp <- corpus_reshape(data_corpus_guardian)

# tokenize text corpus
toks <- tokens(corp)

# convert to tokens_xptr object
xtoks <- as.tokens_xptr(toks)
print(xtoks, max_ndoc = 1)

# shallow copy
xtoks_copy <- xtoks
print(xtoks_copy, max_ndoc = 1)

# deep copy 
xtoks_deepcopy <- as.tokens_xptr(xtoks)
print(xtoks_deepcopy, max_ndoc = 1)
```

## Modifying tokens_xptr objects

You can use `tokens_*` functions to modify `tokens_xptr` objects in the same way as `tokens` objects. `tokens_select()`, `tokens_compound()`, `tokens_lookup()`, `tokens_ngrams()` and `tokens_replace()` will return a shallow copy of the input object for efficiency. However, `tokens_subset()`, `[]`, `tokens_group()`, `tokens_segment()` and `tokens_chunk()` return a deep copy because they can change the number of the order of the documents. Please pay attention to the address of the pointer `(pointer to xxxx)` when you use `tokens_xptr` objects.

```{r}
# shallow copy
xtoks2 <- tokens_remove(xtoks, stopwords("en"))
print(xtoks2, max_ndoc = 1)

# deep copy
xtoks3 <- tokens_subset(xtoks, len > 500)
print(xtoks3, max_ndoc = 1)
```

## Saving tokens_xptr objects

You should also note that you cannot save the underlying data of `tokens_xptr` objects. Thus, you should apply the `as.tokens()` method before passing it to `save()` or `saveRDS()`.

```{r, eval=FALSE}
saveRDS(as.tokens(xtoks), file = "tokens_guardian.rds")
```

## Benchmarking

We apply the same `tokens_*` functions to `tokens` and `tokens_xptr` objects and construct a `dfm` in this mock pipeline. The execution time for the latter is significantly shorter than for the former thanks to the cost saved by passing the data without expensive conversion.

```{r, echo=FALSE, include=FALSE}
# adjust custom ggplot2 theme to make it consistent with other vignettes
ggplot2::theme_set(ggplot2::theme_bw())
```

```{r}
microbenchmark::microbenchmark(
    tokens = toks %>% 
        tokens_remove(stopwords("en"), padding = TRUE) %>% 
        tokens_remove(c("http:*", "https:*", "*.com", "*.org", "*.net"), padding = TRUE) %>% 
        tokens_compound(newsmap::data_dictionary_newsmap_en) %>% 
        dfm(remove_padding = TRUE),
    tokens_xptr = as.tokens_xptr(toks) %>% 
        tokens_remove(stopwords("en"), padding = TRUE) %>% 
        tokens_remove(c("http:*", "https:*", "*.com", "*.org", "*.net"), padding = TRUE) %>% 
        tokens_compound(newsmap::data_dictionary_newsmap_en) %>% 
        dfm(remove_padding = TRUE),
    times = 10
) %>% autoplot(log = FALSE)
```

